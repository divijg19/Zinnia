name: Smoke Endpoints

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    smoke:
        name: Endpoint smoke checks
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Resolve domain
              id: domain
              run: |
                  if [ -n "${{ secrets.PROD_DOMAIN }}" ]; then
                      echo "domain=${{ secrets.PROD_DOMAIN }}" >> $GITHUB_OUTPUT
                  else
                      echo "domain=zinnia-rho.vercel.app" >> $GITHUB_OUTPUT
                  fi

            - name: Smoke check endpoints
              shell: bash
              run: |
                  set -euo pipefail
                  D=${{ steps.domain.outputs.domain }}
                  USERNAME=divijg19

                  endpoints=(
                      "https://$D/api/health?text=OK&cache=0:optional"
                      "https://$D/api/stats?username=${USERNAME}&cache=0:required"
                      "https://$D/api/top-langs?username=${USERNAME}&layout=compact&cache=0:required"
                      "https://$D/api/streak?user=${USERNAME}&cache=0:optional"
                      "https://$D/api/trophy?username=${USERNAME}&cache=0:optional"
                      "https://$D/api/leetcode?username=${USERNAME}&cache=0:optional"
                  )

                  failures=0
                  required_failed=0

                  for e in "${endpoints[@]}"; do
                      url=${e%:*}
                      required=${e##*:}
                      echo "Checking $url (required=${required})"
                      status=$(curl -sS -o /dev/null -w "%{http_code}" --max-time 15 "$url") || status=000
                      if [ "$status" != "200" ]; then
                          echo "✗ $url returned status $status"
                          failures=$((failures+1))
                          if [ "$required" = "required" ]; then
                              required_failed=$((required_failed+1))
                          fi
                          continue
                      fi
                      ct=$(curl -sS -I --max-time 15 "$url" | tr -d '\r' | awk -F': ' '/^content-type:/ {print $2}' | tr -d '\n') || ct=""
                      if [[ ! "$ct" =~ "image/svg" ]]; then
                          echo "✗ $url returned wrong content-type: $ct"
                          failures=$((failures+1))
                          if [ "$required" = "required" ]; then
                              required_failed=$((required_failed+1))
                          fi
                          continue
                      fi
                      body=$(curl -sS --max-time 15 "$url" ) || body=""
                      if [[ ! "$body" =~ "<svg" ]]; then
                          echo "✗ $url body did not contain <svg"
                          failures=$((failures+1))
                          if [ "$required" = "required" ]; then
                              required_failed=$((required_failed+1))
                          fi
                          continue
                      fi
                      echo "✓ $url OK"
                  done

                  echo "Summary: failures=$failures required_failed=$required_failed"
                  if [ "$required_failed" -gt 0 ]; then
                      echo "One or more required endpoints failed" >&2
                      exit 1
                  fi
