name: Refresh and Warm Zinnia Endpoints

on:
  schedule:
    - cron: "0 5 * * *" # daily at 05:00 UTC
  workflow_dispatch: {}

concurrency:
  group: refresh-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  warm:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      USERNAME: divijg19
    steps:
      - name: Resolve domain
        id: domain
        run: |
          if [ -n "${{ secrets.PROD_DOMAIN }}" ]; then
            echo "domain=${{ secrets.PROD_DOMAIN }}" >> $GITHUB_OUTPUT
          else
            echo "domain=zinnia-rho.vercel.app" >> $GITHUB_OUTPUT
          fi
      - name: Warm endpoints (cache=0)
        shell: bash
        run: |
          set -euo pipefail
          D=${{ steps.domain.outputs.domain }}
          for url in \
            "https://$D/api/health?text=OK&cache=0" \
            "https://$D/api/stats?username=${USERNAME}&cache=0" \
            "https://$D/api/top-langs?username=${USERNAME}&layout=compact&cache=0" \
            "https://$D/api/streak?user=${USERNAME}&cache=0" \
            "https://$D/api/trophy?username=${USERNAME}&cache=0" \
            "https://$D/api/leetcode?username=${USERNAME}&cache=0"; do
            curl --retry 3 --retry-delay 2 --max-time 20 -fSIL "$url" | tail -n +1
          done
      - name: Smoke check /api/health
        shell: bash
        run: |
          D=${{ steps.domain.outputs.domain }}
          for i in {1..3}; do
            code=$(curl -sS -o /dev/null -w "%{http_code}" "https://$D/api/health?text=OK")
            if [ "$code" = "200" ]; then
              exit 0
            fi
            sleep 2
          done
          echo "Health endpoint failed after retries (last status: $code)" >&2
          exit 1
