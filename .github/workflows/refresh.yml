name: Refresh and Warm Zinnia Endpoints

on:
  schedule:
    - cron: "0 5 * * *" # daily at 05:00 UTC
  workflow_dispatch: {}

concurrency:
  group: refresh-${{ github.ref }}
  cancel-in-progress: true

jobs:
  warm:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      USERNAME: divijg19
    steps:
      - name: Resolve domain
        id: domain
        run: |
          if [ -n "${{ secrets.PROD_DOMAIN }}" ]; then
            echo "domain=${{ secrets.PROD_DOMAIN }}" >> $GITHUB_OUTPUT
          else
            echo "domain=zinnia-rho.vercel.app" >> $GITHUB_OUTPUT
          fi
      - name: Warm endpoints (cache=0)
        run: |
          set -euo pipefail
          D=${{ steps.domain.outputs.domain }}
          curl -sSIL "https://$D/api/health?text=OK&cache=0" | tail -n +1
          curl -sSIL "https://$D/api/stats?username=${USERNAME}&cache=0" | tail -n +1
          curl -sSIL "https://$D/api/top-langs?username=${USERNAME}&layout=compact&cache=0" | tail -n +1
          curl -sSIL "https://$D/api/streak?user=${USERNAME}&cache=0" | tail -n +1
          curl -sSIL "https://$D/api/trophy?username=${USERNAME}&cache=0" | tail -n +1
          curl -sSIL "https://$D/api/leetcode?username=${USERNAME}&cache=0" | tail -n +1
      - name: Smoke check /api/health
        run: |
          D=${{ steps.domain.outputs.domain }}
          code=$(curl -sS -o /dev/null -w "%{http_code}" "https://$D/api/health?text=OK")
          if [ "$code" != "200" ]; then
            echo "Health endpoint returned $code" >&2
            exit 1
          fi
